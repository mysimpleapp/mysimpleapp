<script>
(function(){

if(!window.Msa) Msa = MySimpleApp = {}

// ower document
Msa.compsUrl = "/bower_components"
var getDoc = Msa.getDoc = function() {
	var script = document._currentScript || document.currentScript
	var doc = script.ownerDocument
	if(!doc) console.warn("Msa.getDoc() failed ! Do not use it in a callback function.")
	return doc
}
var getUrl = Msa.getUrl = function() {
	var doc = getDoc()
	if(doc) return doc._URL || doc.URL
}
var getDirUrl = Msa.getDirUrl = function() {
	var file = getUrl()
	if(!file) return null
	var last = file.lastIndexOf("/")
	return file.substr(0, last)
}

// registerElement
Msa.registerElement = function(name, args) {
	var proto = Object.create(HTMLElement.prototype)
	if(args) {
		var template = getTemplate(args, "template")
		var shadow = getTemplate(args, "shadow")
		var createdCallback = addCallback(proto, args, "createdCallback", "oncreate")
		addCallback(proto, args, "attachedCallback", "onattach")
		addCallback(proto, args, "detachedCallback", "ondetach")
		addCallback(proto, args, "attributeChangedCallback", "onchange")
	}
	proto.createdCallback = function() {
		if(template) {
			this.innerHTML = ""
			appendContent(this, template)
		}
		if(shadow) appendContent(this.createShadowRoot(), shadow)
		if(createdCallback) createdCallback.call(this)
	}
	if (shadow && window.ShadowDOMPolyfill) WebComponents.ShadowCSS.shimStyling(shadow.content, name)
	return document.registerElement(name, {prototype: proto})
}
var getTemplate = function(args, name) {
	var template = args[name]
	if(typeof template == "string")
		template = getDoc().querySelector(template)
	return template
}
var appendContent = function(el, template) {
	var content = document.importNode(template.content, true)
	el.appendChild(content)
}
var addCallback = function(proto, args, fullName, shortName) {
	return proto[fullName] = args[fullName] || args[shortName]
}

// helpers //////////////////////////////////////////////

// method for cached query in dom
Msa.Q = function(query) {
	var qels = this.Qels
	if(qels===undefined)
		qels = this.Qels = {}
	var el = qels[query]
	if(el===undefined)
		el = qels[query] = this.querySelector(query)
	return el
}

// add actions to element
Msa.addActions = function(el, actions, name) {
	// for each action
	for(var i=0, len=actions.length; i<len; ++i) {
		var action = actions[i]
		var aElStr = action.el, evt = action.evt
		let act = action.act
		var listener = function(evt){
			act.call(el, evt, this)
		}
		// find matching child elements
		var aEls = el.querySelectorAll(aElStr)
		// for each of them
		for(var j=0, len2=aEls.length; j<len2; ++j) {
			var aEl = aEls[j]
			// add listener
			aEl.addEventListener(evt, listener)
			// add reference to holder element (if requested)
			if(name) aEl[name] = el
		}
	}
}

// send //////////////////////////////////////////////

var send = Msa.send = function(method, url, arg1, arg2) {
	if(typeof arg1==="function") var onsuccess=arg1
	else var args=arg1, onsuccess=arg2
	// build & send XMLHttpRequest
	var xhr = new XMLHttpRequest()
	// args
	if(args) {
		var query = args.query
		var body = args.body
		var header = args.header
		// callbacks
		for(var evt in args) {
			if(evt.substring(0, 2)!="on") continue
			else if(evt==="onbadperm")
				xhr.onstatus401 = xhr.onstatus403 = args[evt]
			else xhr[evt] = args[evt]
		}
		// res format
		xhr.parseRes = args.parseRes
	}
	// onsuccess
	if(onsuccess) xhr.onsuccess = onsuccess
	// default onload
	if(!xhr.onload) xhr.onload = _send_defaultOnload
	// url (with query)
	if(query) url = formatUrl(url, query)
	xhr.open(method, url, true)
	// body
	if(body) {
		// body format
		var contentType = args.contentType
		if(contentType===undefined){
      var bodyType = typeof body
      var contentType = (bodyType==="object") ? 'application/json' : 'text/plain'
    }
		if(contentType) xhr.setRequestHeader('Content-Type', contentType)
		// format 
		if(contentType==='application/json')
			body = JSON.stringify(body)
	}
	// header
	if(header)
		for(var h in header)
			xhr.setRequestHeader(h, header[h])
	// send request
	xhr.send(body)
}
Msa.get = function(url, arg1, arg2) { send("GET", url, arg1, arg2) }
Msa.post = function(url, arg1, arg2) { send("POST", url, arg1, arg2) }
Msa.put = function(url, arg1, arg2) { send("PUT", url, arg1, arg2) }
Msa.delete = function(url, arg1, arg2) { send("DELETE", url, arg1, arg2) }

var _send_defaultOnload = function(evt) {
	var xhr = evt.target, status = xhr.status
	_send_parseRes(evt, xhr["onstatus"+status])
	if(status>=200 && status<300)
		_send_parseRes(evt, xhr.onsuccess)
	if(status>=400)
		_send_parseRes(evt, xhr.onerror)
}
var _send_parseRes = function(evt, next){
	if(!next) return
	var xhr = evt.target
	var parseRes = (xhr.parseRes !== false)
	var type = xhr.getResponseHeader('content-type').split(';')[0]
	if(parseRes && type==='application/json'){
		var res = xhr.responseText
		var json = res ? JSON.parse(res) : null
		next(json, evt)
	} else if(parseRes && type==='application/xml'){
		next(xhr.responseXML, evt)
	} else {
		next(xhr.responseText, evt)
	}
}

// URL serialization /////////////////////////////////////////////

var formatUrl = Msa.formatUrl = function(arg1, arg2) {
	// get base from location, if not provided
	if(arg2!==undefined) var base = arg1, args = arg2
	else var args = arg1, loc = window.location, base = loc.origin + loc.pathname
	// add args, if provided
	var res = base
	if(args) {
		var urlArgs = formatUrlArgs(args)
		if(urlArgs) res += '?' + formatUrlArgs(args)
	}
	return res
}
var formatUrlArgs = Msa.formatUrlArgs = function(args) {
	var res = []
	for(var a in args) {
		var val = args[a]
		if(val!==null && val!=="")
			res.push(encodeURIComponent(a) + "=" + encodeURIComponent(args[a]))
	}
	return res.join("&")
}

var parseUrl = Msa.parseUrl = function(str) {
	// get string from location, if not provided
	if(str===undefined) str = window.location.href
	var res = { base:null, args:null }
	var pair = str.split('?')
	res.base = pair[0]
	var argsStr = pair[1]
	if(argsStr!==undefined)
		res.args = parseUrlArgs(argsStr)
	return res
}
var parseUrlArgs = Msa.parseUrlArgs = function(str) {
	// get string from location, if not provided
	if(str===undefined) str = window.location.search.substring(1)
	// parse args
	var res = {}
	str.split("&").forEach(function(keyVal){
		var pair = keyVal.split('=')
		if(pair.length==2)
			res[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1])
	})
	return res
}

// formatHtml: format HTML expression to HTML object
Msa.formatHtml = function(htmlExpr) {
	return _formatHtml(htmlExpr, true)
}
var _formatHtml = function(htmlExpr, isHead) {
	// fill head & body objects
	var head = new Set(), body = []
	_formatHtml_core(htmlExpr, head, body, isHead)
	// format head & body to sring
	var bodyStr = body.join('\n')
	var headStr = "", firstHead = true
	for(var h of head) {
		if(firstHead) firstHead = false
		else headStr += '\n'
		headStr += h
	}
	// return HTML string
	return { head:headStr, body:bodyStr }
}
var _formatHtml_core = function(htmlExpr, head, body, isHead) {
	var type = typeof htmlExpr
	// case string
	if(type==="string") {
		_formatHtml_push(htmlExpr, head, body, isHead)
	} else if(type==="object") {
		// case array
		var len = htmlExpr.length
		if(len!==undefined) {
			for(var i=0; i<len; ++i)
				_formatHtml_core(htmlExpr[i], head, body, isHead)
		// case object
		} else {
			var tag = htmlExpr.tag
			var cnt = htmlExpr.content || htmlExpr.cnt
			var attrs = htmlExpr.attributes || htmlExpr.attrs
			var style = htmlExpr.style
			var imp = htmlExpr.import
			var js = htmlExpr.script || htmlExpr.js
			var css = htmlExpr.stylesheet || htmlExpr.css
			var wel = htmlExpr.webelement || htmlExpr.wel
			// web element
			if(wel) {
				_formatHtml_core({import:wel}, head, body, isHead)
				tag = tag || _formatHtml_getWelTag(wel)
				isHead = false
			}
			// html import
			if(imp && !tag) {
				var importUrl = _formatHtml_toUrl(imp)
				tag = 'link'
				attrs = attrs || {}
				attrs.rel = 'import'
				attrs.href = importUrl
				isHead = true
			}
			// script
			if(js && !tag) {
				var jsUrl = _formatHtml_toUrl(js)
				tag = 'script'
				attrs = attrs || {}
				attrs.src = jsUrl
				isHead = true
			}
			// stylesheet
			if(css && !tag) {
				var cssUrl = _formatHtml_toUrl(css)
				tag = 'link'
				attrs = attrs || {}
				attrs.rel = 'stylesheet'
				attrs.type = 'text/css'
				attrs.href = cssUrl
				isHead = true
			}
			// tag (with attrs & content)
			tag = htmlExpr.tag || tag
			if(tag) {
				var str = '<'+tag
				// style
				if(style) {
					if(!attrs) attrs={}
					attrs.style = style
				}
				// attrs
				if(attrs)
					for(var a in attrs) {
						var val = attrs[a]
						if(a=='style') val = _formatHtml_style(val)
						str += ' '+ a +'="'+ val +'"'
					}
				str += '>'
				_formatHtml_push(str, head, body, isHead)
				// content
				if(cnt) _formatHtml_core(cnt, head, body, isHead)
				_formatHtml_push('</'+tag+'>', head, body, isHead)
			}
			// body
			_formatHtml_core(htmlExpr.body, head, body, false)
			// head
			_formatHtml_core(htmlExpr.head, head, body, true)
		}
	}
}
var _formatHtml_style = function(style) {
	var type = typeof style
	if(type==="string") return style
	else if(type==="object") {
		var str = ""
		for(var a in style) str += a+':'+style[a]+'; '
		return str
	}
}
var _formatHtml_push = function(html, head, body, isHead) {
	if(isHead) head.add(html)
	else body.push(html)
}
var _formatHtml_getWelTag = function(wel) {
	return /([a-zA-Z0-9-_]*)\.html$/.exec(wel)[1]
}
var _formatHtml_toUrl = function(url) {
	return url
}

// import
Msa.import = function(html, el, args) {
	if(typeof args==='function') args = { onload: args }
	var html = _formatHtml(html, true)
	var head = html.head, body = html.body
	var onload = args && args.onload, onerror = args && args.onerror
	var newEls = [], nbLoading = 1, nbErrs = 0
	var waiter = function() {
		if(--nbLoading===0) {
			if(nbErrs>0 ) { if(onerror) onerror() }
			else if(onload) onload(newEls)
		}
	}
	if(head) {
		var template = document.createElement("template")
		template.innerHTML = head
		var children=template.content.children, len=children.length
		nbLoading += len
		for(var i=0; i<len; ++i) {
			var clone = document.importNode(children[i], true)
			clone.addEventListener("load", waiter)
			clone.addEventListener("error", function(){
				nbErrs += 1
				waiter()
			})
			document.head.appendChild(clone)
		}
	}
	if(body) {
		var template = document.createElement("template")
		template.innerHTML = body
		var children=template.content.childNodes, len=children.length
		for(var i=0; i<len; ++i) {
			var clone = document.importNode(children[i], true)
			if(el) el.appendChild(clone)
			newEls.push(clone)
		}
	}
	waiter()
}
})()
</script>
